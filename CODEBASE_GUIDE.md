# novel-api (UKK) ‚Äî Codebase Guide (feature-grouped)

> This document is generated by scanning the actual code under this repo (controllers, models, migrations, middleware, helpers). It is **not copied** from existing markdown files.
>
> Scope note: this is the backend located in `backend/` and is a Laravel app using Sanctum for API auth.

## üìå Quick orientation

### Entrypoints and where to look

- Routes:
  - `routes/api.php` ‚Äî main JSON API surface.
  - `routes/web.php` ‚Äî browser routes (mostly Telescope login).
- Controllers:
  - `app/Http/Controllers/*` ‚Äî endpoint implementations.
  - `app/Http/Controllers/Auth/AuthController.php` ‚Äî auth endpoints.
- Domain models (Eloquent): `app/Models/*`
- DB schema changes: `database/migrations/*`
- Middleware:
  - `app/Http/Middleware/AdminMiddleware.php` (`admin`)
  - `app/Http/Middleware/AuthorMiddleware.php` (`author`)
  - `app/Http/Middleware/EnsureEmailIsVerified.php` (`verified`)
- Caching helper:
  - `app/Helpers/CacheHelper.php`
  - cache store config: `config/cache.php`

### Conventions used by the code

- **Route model binding**
  - `Novel` binds by `slug` (see `Novel::getRouteKeyName()`), so endpoints like `novels/{novel:slug}` inject a `Novel`.
- **Auth**
  - Most protected endpoints use `auth:sanctum`.
  - Roles are modeled as integer constants on `User`.

### Roles & permissions (from `app/Models/User.php`)

- `ROLE_USER = 0`
- `ROLE_AUTHOR = 1`
- `ROLE_MODERATOR = 2`
- `ROLE_ADMIN = 3`

Helper methods:
- `isAdmin()`
- `canCreateNovels()` (author/moderator/admin)

Middleware:
- `author` => requires `canCreateNovels()`
- `admin` => requires `isAdmin()`
- `verified` => requires `hasVerifiedEmail()`

---

## Feature: Authentication & Profile

### Models involved

- `User` (`app/Models/User.php`)

### Endpoints (from `routes/api.php`)

#### Public

- `POST /auth/register` ‚Üí `AuthController@register`
- `POST /auth/login` ‚Üí `AuthController@login`
- `GET /auth/google` ‚Üí `AuthController@redirectToGoogle`
- `GET /auth/google/callback` ‚Üí `AuthController@handleGoogleCallback`
- `GET /auth/email/verify/{id}/{hash}` ‚Üí `AuthController@verifyEmail` (named route `verification.verify`)

#### Protected (`auth:sanctum`)

- `POST /auth/logout` ‚Üí `AuthController@logout`
- `GET /auth/me` ‚Üí `AuthController@me`
- `PUT /auth/profile` ‚Üí `AuthController@updateProfile`
- `PUT /auth/change-password` ‚Üí `AuthController@changePassword`
- `POST /auth/email/verification-notification` ‚Üí `AuthController@sendEmailVerification`
- `POST /auth/email/resend-verification` ‚Üí `AuthController@resendEmailVerification`

Other:
- `GET /user` (closure) ‚Äî returns authenticated user.

### Request/Response behavior (from `AuthController`)

#### `POST /auth/register`

Validates:
- `name` (required)
- `email` (required, unique)
- `password` (required, min 8, `confirmed`)

Creates a `User` with:
- `provider = "email"`
- sends email verification via `sendEmailVerificationNotification()`
- issues Sanctum token: `$user->createToken('auth_token')`

Returns `201` with:
- `user` (id, name, email, verification info, role, avatar, bio, `is_admin`)
- `token`

#### `POST /auth/login`

- Uses `Auth::attempt()`.
- Updates `last_login_at`.
- Issues token.

Returns `401` for invalid credentials.

#### Google OAuth (`/auth/google`, `/auth/google/callback`)

- Uses Socialite (`Laravel\Socialite\Facades\Socialite`).
- Supports `?telescope=true` which sets OAuth `state=telescope` and changes callback behavior.
- On callback:
  - If user exists, updates provider info / last login.
  - Else creates a user and sets `email_verified_at = now()`.
  - Issues a Sanctum token.
  - Redirects to frontend (`FRONTEND_URL`, default `https://rantale.randk.me`) with `token` + base64-encoded `user`.

---

## Feature: Author Applications & Author Stats

### Models involved

- `AuthorApplication`
- `User`

### Endpoints

#### Protected (`auth:sanctum`)

- `POST /author/apply` ‚Üí `AuthorApplicationController@apply`
- `GET /author/application-status` ‚Üí `AuthorApplicationController@getStatus`

#### Protected (`auth:sanctum` + `author`)

- `GET /author/stats` ‚Üí `AuthorController@getStats`
- `GET /author/novels` ‚Üí `AuthorController@getNovels`

#### Admin-only (`auth:sanctum` + `admin`)

- `GET /admin/author-applications` ‚Üí `AuthorApplicationController@adminIndex`
- `GET /admin/author-applications/{application}` ‚Üí `AuthorApplicationController@adminShow`
- `POST /admin/author-applications/{application}/approve` ‚Üí `AuthorApplicationController@approve`
- `POST /admin/author-applications/{application}/reject` ‚Üí `AuthorApplicationController@reject`
- `PUT /admin/author-applications/{application}/notes` ‚Üí `AuthorApplicationController@updateNotes`

### AuthorApplication business rules (from `AuthorApplication::validationRules()`)

- `bio` required (50‚Äì1000 chars)
- `writing_experience` required (100‚Äì2000 chars)
- `pen_name` optional
- `sample_work` optional
- `portfolio_url` optional URL

Status values:
- `pending`, `approved`, `rejected`

---

## Feature: Admin Dashboard & Moderation

### Middleware

- `admin` checks:
  - authenticated
  - `user->isAdmin()`

### Endpoints

- `GET /admin/dashboard/stats` ‚Üí `AdminController@getDashboardStats`
- `GET /admin/activity` ‚Üí `AdminController@getRecentActivity`
- `GET /admin/system-health` ‚Üí `AdminController@getSystemHealth`

User management:
- `GET /admin/users` ‚Üí `AdminController@getUserManagement`
- `PUT /admin/users/{user}` ‚Üí `AdminController@updateUser`

Moderation:
- `GET /admin/moderation` ‚Üí `AdminController@getModerationQueue`

Comments moderation:
- `GET /admin/comments` ‚Üí `CommentController@adminIndex`
- `PUT /admin/comments/{comment}/toggle-approval` ‚Üí `CommentController@adminToggleApproval`

---

## Feature: Novels (catalog + author CRUD)

### Models involved

- `Novel`
- `Genre` (many-to-many)
- `Chapter` (has-many)
- `Rating` (has-many)
- `Comment` (has-many)
- `UserLibrary` (has-many)

### Key model behaviors (from `app/Models/Novel.php`)

- Fillable fields include: `user_id`, `title`, `author`, `slug`, `description`, `status`, `cover_image`, `total_chapters`, `views`, `rating`, `rating_count`, flags like `is_featured`.
- Slug generation:
  - If `slug` is empty on create, it‚Äôs generated from title.
  - Ensures uniqueness by appending `-N`.
- Cache invalidation:
  - On save: clears novel caches if fields changed **except** `views`.
  - On delete: clears novel caches.

### Endpoints

#### Public read

- `GET /novels` ‚Üí `NovelController@index`
  - supports filtering/sorting; uses cached pagination keyed by full URL.
- `GET /novels/search?q=...` ‚Üí `NovelController@search` (cached per query)
- `GET /novels/popular` ‚Üí `NovelController@popular`
- `GET /novels/latest` ‚Üí `NovelController@latest`
- `GET /novels/recently-updated?limit=N` ‚Üí `NovelController@recentlyUpdated`
- `GET /novels/recommendations` ‚Üí `NovelController@recommendations`
- `GET /novels/genres` ‚Üí `NovelController@genres`
- `GET /novels/{slug}` ‚Üí `NovelController@show` (NOT cached; increments views)
- `GET /novels/{slug}/related` ‚Üí `NovelController@related`

#### Author write (`auth:sanctum` + `author`)

- `POST /novels` ‚Üí `NovelController@store`
- `PUT /novels/{slug}` ‚Üí `NovelController@update` (owner or admin enforced in controller)
- `DELETE /novels/{slug}` ‚Üí `NovelController@destroy` (owner or admin)
- `POST /novels/bulk-delete` ‚Üí `NovelController@bulkDestroy`

### Filtering/sorting for `GET /novels`

- Filter by genre: `?genre=<genreSlug>` (via `whereHas('genres')`)
- Filter by status: `?status=ongoing|completed|hiatus`
- Sorting:
  - `?sort_by=popular|rating|latest|updated|<column>`
  - `?sort_order=asc|desc`

### Algorithms

#### Related novels (`NovelController@related`) ‚Äî hybrid similarity scoring

If the current novel has no genres ‚Üí fallback to popular novels by views.

Otherwise:
- Candidate set: novels sharing at least one genre.
- Scoring (max 100-ish, stored as `similarity_score`):
  - Genre overlap: up to 50 points (matching/total genres)
  - Same author: +20
  - Similar rating: up to 15 (penalized by rating diff)
  - Similar popularity (log views): up to 10
  - Same status: +5
- Returns top 6.

### Caching notes

- Uses `CacheHelper::remember()` which supports cache tags if driver supports it.
- Key patterns you‚Äôll see:
  - `novels_index_<md5(fullUrl)>`
  - `novel_search_<md5(query)>`
  - `novels_popular`, `novels_latest`, `novels_recently_updated_<limit>`
  - `novels_recommendations`
  - `novel_related_<slug>`

---

## Feature: Chapters (read + author CRUD)

### Models involved

- `Chapter`
- `Novel`

### Model behaviors (from `app/Models/Chapter.php`)

- On create: increments parent novel‚Äôs `total_chapters` and touches novel.
- On delete: decrements `total_chapters` and touches novel.
- On save/delete: clears caches via `CacheHelper::clearChapterCaches()`.

### Endpoints

#### Public read

- `GET /novels/{novel:slug}/chapters` ‚Üí `ChapterController@index`
  - Cached list under `chapters_novel_{novelId}`.
- `GET /novels/{novel:slug}/chapters/{chapterNumber}` ‚Üí `ChapterController@show`
  - Cached chapter content under `chapter_{novelId}_{chapterNumber}`.
  - Increments chapter views each request (not cached).
  - Adds navigation `previous_chapter` and `next_chapter` to response.

#### Author write (`auth:sanctum` + `author`)

- `POST /novels/{novel:slug}/chapters` ‚Üí `ChapterController@store`
- `PUT /novels/{novel:slug}/chapters/{chapter}` ‚Üí `ChapterController@update`
- `DELETE /novels/{novel:slug}/chapters/{chapter}` ‚Üí `ChapterController@destroy`
- `POST /novels/{novel:slug}/chapters/bulk-delete` ‚Üí `ChapterController@bulkDestroy`

### Chapter creation rules (from `ChapterController@store`)

- Only novel owner or admin can add chapters.
- Accepts optional `chapter_number`:
  - If omitted, auto-increments last chapter number.
  - If provided, conflicts return `409`.
- Computes `word_count = str_word_count(strip_tags(content))`.
- After creation, sends notifications to users following the novel (see Notifications feature).

---

## Feature: Comments & Voting

### Models involved

- `Comment`
- `CommentVote`
- `Notification` (reply notifications)

### Endpoints

#### Public read

- `GET /novels/{novel:slug}/comments` ‚Üí `CommentController@index` (novel-level comments)
- `GET /novels/{novel:slug}/chapters/{chapterNumber}/comments` ‚Üí `CommentController@index` (chapter comments)

#### Authenticated write (`auth:sanctum`)

- `POST /comments` ‚Üí `CommentController@store`
- `PUT /comments/{comment}` ‚Üí `CommentController@update`
- `DELETE /comments/{comment}` ‚Üí `CommentController@destroy` (owner or admin)

Voting:
- `POST /comments/{comment}/vote` ‚Üí `CommentController@vote` (toggle/upsert)
- `GET /comments/{comment}/vote` ‚Üí `CommentController@getUserVote`
- `GET /comments/votes?comment_ids=1,2,3` ‚Üí `CommentController@bulkVotes`

#### Verified-email requirement example

- `POST /comments/verified-only` ‚Üí `CommentController@store` (protected by `verified` middleware)

#### Admin-only

- `GET /admin/comments` ‚Üí `CommentController@adminIndex`
- `PUT /admin/comments/{comment}/toggle-approval` ‚Üí `CommentController@adminToggleApproval`

### Threading model

- Nested comments are modeled via `parent_id`.
- `Comment::replies()` returns only approved replies.

### Important implementation detail

In `CommentController@index`, when `chapterNumber` is passed, it currently looks up:

```php
Chapter::where('novel_id', $novel->id)
  ->where('id', $chapterNumber) // note: uses id, not chapter_number
```

So the `{chapterNumber}` route parameter is treated as a **chapter id** in that controller method (despite the variable name). If clients are sending chapter numbers, this mismatch will matter.

---

## Feature: Ratings

### Models involved

- `Rating`
- `Novel` (stores aggregate rating + count)

### Endpoints

#### Public read

- `GET /novels/{novel:slug}/ratings` ‚Üí `RatingController@index`
  - lists only ratings with non-null `review`.
  - returns distribution + average from `Novel`.

#### Authenticated write (`auth:sanctum`)

- `POST /ratings` ‚Üí `RatingController@store` (create or update)
- `DELETE /ratings/{rating}` ‚Üí `RatingController@destroy` (owner or admin)

User convenience:
- `GET /novels/{novel:slug}/my-rating` ‚Üí `RatingController@getUserRating`
- `GET /my-ratings` ‚Üí `RatingController@getUserRatings`

### Rating rules

- One rating per user per novel is enforced by a DB unique index (`user_id`, `novel_id`) and by controller logic.
- After create/update/delete, `Novel::updateRating()` recalculates:
  - `rating_count`
  - `rating` (avg, rounded to 2 decimals)

---

## Feature: Reading Progress

### Model involved

- `ReadingProgress` links `user_id`, `novel_id`, `chapter_id`.

### Endpoints (all `auth:sanctum`)

- `GET /reading-progress/user` ‚Üí `ReadingProgressController@getUserProgress`
- `GET /reading-progress/{novel:slug}` ‚Üí `ReadingProgressController@getProgress`
- `POST /reading-progress` ‚Üí `ReadingProgressController@createProgress`
- `PUT /reading-progress` ‚Üí `ReadingProgressController@updateProgress`
- `DELETE /reading-progress/{novel:slug}` ‚Üí `ReadingProgressController@deleteProgress`

### Key behavior

- `updateProgress` preserves progress if user navigates backward:
  - Only updates saved progress if:
    - no existing progress, OR
    - requested chapter number is greater than saved.
- Progress percentage is computed as:

$$\text{progress} = \begin{cases}
0 & \text{if } total\_chapters = 0\\
\text{round}(\frac{chapter\_number}{total\_chapters} \cdot 100, 2) & \text{otherwise}
\end{cases}$$

---

## Feature: User Library (tracking + favorites)

### Model involved

- `UserLibrary` (unique per user+novel)

Statuses:
- `want_to_read`, `reading`, `completed`, `dropped`, `on_hold`

### Endpoints (all `auth:sanctum`)

- `GET /library` ‚Üí `UserLibraryController@index`
  - Query params:
    - `status=all|favorites|<status>`
    - `favorites=true` (backward compatible)
  - Returns stats counts.
- `POST /library` ‚Üí `UserLibraryController@store` (create or update)
- `PUT /library/{library}` ‚Üí `UserLibraryController@update`
- `DELETE /library/{library}` ‚Üí `UserLibraryController@destroy`
- `GET /library/novel/{novel:slug}/status` ‚Üí `UserLibraryController@checkStatus`
- `POST /library/novel/{novel:slug}/toggle-favorite` ‚Üí `UserLibraryController@toggleFavorite`
- `GET /library/statuses` ‚Üí `UserLibraryController@getStatuses`

---

## Feature: Notifications

### Models involved

- `Notification`

### Endpoints (all `auth:sanctum`)

- `GET /notifications` ‚Üí `NotificationController@index`
- `GET /notifications/unread-count` ‚Üí `NotificationController@getUnreadCount`
- `PUT /notifications/{notification}/read` ‚Üí `NotificationController@markAsRead`
- `PUT /notifications/{notification}/unread` ‚Üí `NotificationController@markAsUnread`
- `PUT /notifications/mark-all-read` ‚Üí `NotificationController@markAllAsRead`
- `DELETE /notifications/{notification}` ‚Üí `NotificationController@destroy`
- `DELETE /notifications/clear-read` ‚Üí `NotificationController@clearRead`

### Notification types (from `Notification` model)

- `new_chapter`
- `comment_reply`
- `author_status`
- `novel_update`
- `system`

### Creation points in code

- New chapter:
  - `ChapterController` calls `Notification::createNewChapterNotification(...)` for users following (library entries).
- Comment reply:
  - `CommentController@store` calls `Notification::createCommentReplyNotification(...)`.

---

## Cross-cutting: Caching

### CacheHelper (`app/Helpers/CacheHelper.php`)

- Provides `remember()` and `flush()` with best-effort tag support.
- Tag support is enabled when cache driver in `config('cache.default')` is one of:
  - `redis`, `memcached`, `octane`
- Otherwise, it falls back to key-based `Cache::forget()`.

### Artisan commands

- `php artisan cache:clear-novels` (optionally `--tag=...`) ‚Äî clears novel caches via cache tags.
- `php artisan novels:fix-chapter-counts` ‚Äî recalculates `novels.total_chapters` from actual chapters.

---

## Practical ERD (based on models/migrations)

This is a ‚Äúdeveloper ERD‚Äù describing the relationships used throughout controllers.

- `users`
  - 1 ‚Üí N `novels` (via `novels.user_id`)
  - 1 ‚Üí N `comments`
  - 1 ‚Üí N `ratings`
  - 1 ‚Üí N `user_libraries`
  - 1 ‚Üí N `reading_progress`
  - 1 ‚Üí N `notifications`
  - 1 ‚Üí 1 `author_applications`

- `novels`
  - 1 ‚Üí N `chapters`
  - 1 ‚Üí N `comments`
  - 1 ‚Üí N `ratings`
  - 1 ‚Üí N `user_libraries`
  - 1 ‚Üí N `reading_progress`
  - N ‚Üî N `genres`

- `chapters`
  - belongs to `novels`
  - 1 ‚Üí N `comments` (optional, chapter comments)

- `comments`
  - belongs to `users`
  - belongs to `novels`
  - optionally belongs to `chapters`
  - self-referencing replies via `parent_id`
  - 1 ‚Üí N `comment_votes`

- `ratings`
  - belongs to `users`
  - belongs to `novels`

- `user_libraries`
  - belongs to `users`
  - belongs to `novels`

- `reading_progress`
  - belongs to `users`
  - belongs to `novels`
  - belongs to `chapters`

- `notifications`
  - belongs to `users`

---

## Suggested ‚Äúfeature-by-feature‚Äù onboarding order

If you‚Äôre onboarding a new dev, this is the most natural learning sequence for this codebase:

1. Auth + roles (`AuthController`, `User`, middleware)
2. Novels read surface (`NovelController@index/show/search`)
3. Chapters read surface + navigation (`ChapterController@index/show`)
4. Comments + votes (threading + moderation)
5. Ratings (aggregate rating updates)
6. Library + favorites (status stats)
7. Reading progress (forward-only update logic)
8. Notifications (new chapter + comment reply)
9. Admin + author application workflow
10. Caching patterns + invalidation + artisan utilities

---

## Known sharp edges / things to double-check

- **Chapter comments route param mismatch**: `CommentController@index` interprets `{chapterNumber}` as `chapters.id` (by querying `where('id', $chapterNumber)`), while the route name suggests chapter number.
- **Migrations vs current model fields**: the earliest migrations create minimal schemas; later migrations add many more fields. When debugging schema issues, always check the full migration chain.

